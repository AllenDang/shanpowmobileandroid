// Generated by CoffeeScript 1.7.1
var DidFailSaveReadingStatus, DidGetComment, DidSaveReadingStatus, SaveReadingStatus;

$(document).on("deviceready", function() {
  var actionbar;
  actionbar = template("public/ActionBar");
  $(".container").before(actionbar());
  $(".spinner").remove();
  $(".actionbar .channel").addClass("hide");
  $(".actionbar .slide-menu").addClass("hide");
  $(".actionbar .write").removeClass("hide");
  $(".actionbar .write .left").removeClass("active");
  $(".actionbar .write .right").addClass("active");
  $(".actionbar .page-title").text("");
  $(".actionbar").children(".center").css("left", ($(window).width() - $(".actionbar .center").children(".page-title").width()) / 2);
  window.status = getQueryString("status");
  window.bookid = getQueryString("bookid");
  window.category = unescape(getQueryString("category"));
  window.bookcover = getQueryString("bookcover");
  window.isforman = getQueryString("isforman");
  window.booktitle = unescape(getQueryString("booktitle"));
  $("textarea").height($(window).height() - 310);
  $(".button.post").unbind("tap").on("tap", function(event) {
    if ($(this).attr("disabled")) {
      return;
    }
    if ($("input.title").val() === "" || $("input.title").val().length <= 0) {
      navigator.notification.alert("请输入评论标题", null);
    } else {
      SaveReadingStatus(window.status, event);
    }
  });
  $(".actionbar .write").unbind("click").on("click", function(event) {
    var longLocation;
    longLocation = location.href;
    location.href = longLocation.replace("Review", "Comment");
  });
  RequestAjax("GET", "/mj/review/write/" + window.bookid, {}, DidGetComment, null, null);
  $(document).on("click tap", ".actionbar .back", null, (function(event) {
    event.preventDefault();
    return window.history.go(-2);
  }));
  $(document).on("backbutton", function(event) {
    event.preventDefault();
    window.history.go(-2);
  });
  $(".button.cancel").unbind("click").on("click", function(event) {
    window.history.go(-2);
  });
});

DidGetComment = function(data, rawData) {
  $("input.title").val(data.Data.Title);
  $("textarea").val(data.Data.Content);
  $(".ratingStar").data("score", data.Data.Score);
  $(".ratingStar").raty({
    score: function() {
      return $(this).data("score");
    },
    halfShow: false,
    starOff: 'http://shanpowbookcover.qiniudn.com/star-off.png',
    starOn: 'http://shanpowbookcover.qiniudn.com/star-on.png',
    size: 16,
    click: (function(score, evt) {
      $(this).data("score", score);
    })
  });
};

SaveReadingStatus = function(statusCode, event) {
  var data, _ref, _ref1, _ref2;
  $(event != null ? event.target : void 0).text("正在发布...");
  $(event != null ? event.target : void 0).attr("disabled", true);
  data = {
    reviewTitle: (_ref = $("input.title").val()) != null ? _ref : "",
    reviewContent: (_ref1 = $("textarea").val()) != null ? _ref1 : "",
    bookTitle: window.booktitle,
    score: parseInt((_ref2 = $(".ratingStar").data("score")) != null ? _ref2 : 0),
    markType: statusCode,
    bookImageUrl: window.bookcover,
    bookCategory: window.category,
    bookForMan: window.isforman,
    isShareToQQ: false,
    isShareToWeibo: false
  };
  RequestAjax("POST", "/book/" + window.bookid + "/addreview", data, DidSaveReadingStatus, DidFailSaveReadingStatus, null);
};

DidSaveReadingStatus = function(data, rawData) {
  $(".button.post").text("发布");
  $(".button.post").attr("disabled", false);
  navigator.notification.alert("评论已经发布成功！", (function() {
    return window.history.go(-2);
  }), "", "好的");
};

DidFailSaveReadingStatus = function(data, rawData) {};
