// Generated by CoffeeScript 1.7.1
var DidGetBookDetailData, DidMarkWantToRead, FailGetBookDetailData, FailMarkWantToRead;

$(document).on("deviceready", function() {
  var bookId;
  bookId = getQueryString("id");
  RequestAjax("GET", "/mj/book/" + bookId, {}, DidGetBookDetailData, FailGetBookDetailData);
});

DidGetBookDetailData = function(data, rawData) {
  var bookDetail, htmlString;
  bookDetail = template("Book/Detail");
  htmlString = bookDetail(data.Data);
  if (htmlString.search("Template Error") < 0) {
    $(".container").replaceWith(bookDetail(data.Data));
  } else {
    ShowLoadingError();
    return;
  }
  $(".actionbar .page-title").text(data.Data.Book.Title);
  CenterTitle();
  if ($(".summaryContent").height() <= 80) {
    $(".expand").hide();
  } else {
    window.fullSummary = $(".summaryContent").text();
    $(".summaryContent").text($(".summaryContent").text().substr(0, 80) + "...");
  }
  $(".expand").parent().unbind("click").on("click", function(event) {
    if ($(this).find(".expand").hasClass("expanded")) {
      $(this).find(".expand").removeClass("expanded");
      $(".summaryContent").text($(".summaryContent").text().substr(0, 80) + "...");
    } else {
      $(this).find(".expand").addClass("expanded");
      $(".summaryContent").text(window.fullSummary);
    }
  });
  $(".statusAction[data-statuscode='wanttoread']").unbind("click").on("click", function(event) {
    var bookId;
    if ($(this).hasClass("inactive")) {
      return;
    }
    $(this).find(".wanttoread").addClass("active");
    bookId = $(".container").attr("id");
    data = {
      markType: "wanttoread",
      score: 0,
      content: "",
      isShareToQQ: false,
      isShareToWeibo: false
    };
    return RequestAjax("POST", "/book/" + bookId + "/mark", data, DidMarkWantToRead, FailMarkWantToRead, false);
  });
  $(".ratingStar").raty({
    score: function() {
      return $(this).data("score") / 2;
    },
    halfShow: false,
    starOff: '../public/img/Star_Big_Off_Green.png',
    starOn: '../public/img/Star_Big_On_Green.png',
    hints: window.scoreHints,
    noRatedMsg: window.scoreNoRatedMsg,
    readOnly: true,
    size: 10,
    width: false
  });
  $(".cmtScore").raty({
    score: function() {
      return $(this).data("score");
    },
    halfShow: false,
    starOff: '../public/img/Star_Small_Off_White.png',
    starOn: '../public/img/Star_Small_On_White.png',
    hints: window.scoreHints,
    noRatedMsg: window.scoreNoRatedMsg,
    readOnly: true,
    size: 10,
    width: 70
  });
  $(".reviewScore").raty({
    score: function() {
      return $(this).data("score");
    },
    halfShow: false,
    starOff: '../public/img/Star_Small_Off_White.png',
    starOn: '../public/img/Star_Small_On_White.png',
    hints: window.scoreHints,
    noRatedMsg: window.scoreNoRatedMsg,
    readOnly: true,
    size: 10,
    width: 70
  });
  $(".readButton").unbind("click").click(function(event) {
    var url;
    url = $(this).data("url");
    cordova.exec(null, null, "ActivityLauncher", "openWebView", [url]);
  });
};

FailGetBookDetailData = function(data, rawData) {};

DidMarkWantToRead = function(data, rawData) {
  $(".statusAction").each(function() {
    if (!$(this).find(".active").hasClass("wanttoread")) {
      $(this).find(".active").removeClass("active");
    }
  });
  $(".selfComment .arrow").removeClass().addClass("offset1 text-center arrow");
};

FailMarkWantToRead = function(data, rawData) {
  cordova.exec(null, null, "ToastHelper", "show", ["标记失败，请点击重试"]);
};
