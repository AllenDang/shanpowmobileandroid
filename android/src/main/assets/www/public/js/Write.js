// Generated by CoffeeScript 1.7.1
var DidFailSaveReadingStatus, DidFailSaveReview, DidSaveReadingStatus, DidSaveReview, PostMarkAjaxRequest, SaveReadingStatus, SaveReview;

$(".ratingStar").raty({
  score: function() {
    return $(this).data("score");
  },
  halfShow: false,
  starOff: 'http://shanpowbookcover.qiniudn.com/star-off.png',
  starOn: 'http://shanpowbookcover.qiniudn.com/star-on.png',
  size: 16,
  click: (function(score, evt) {
    $(this).data("score", score);
  })
});

$("#short textarea").height($(window).height() - 200);

$(document).on("deviceready", function() {
  window.status = getQueryString("status");
  window.bookid = getQueryString("bookid");
  if (window.content) {
    $("#short textarea").val(window.content);
  }
});

$(".button.post").unbind("tap").on("tap", function(event) {
  if ($(this).attr("disabled")) {
    return;
  }
  SaveReadingStatus(window.status, event);
});

SaveReadingStatus = function(statusCode, event) {
  var data, _ref, _ref1;
  $(event != null ? event.target : void 0).text("正在发布...");
  $(event != null ? event.target : void 0).attr("disabled", true);
  data = {
    markType: statusCode,
    score: parseInt((_ref = $(".ratingStar").data("score")) != null ? _ref : 0),
    content: (_ref1 = $("#short textarea").val()) != null ? _ref1 : ""
  };
  PostMarkAjaxRequest("mark", "POST", data, (function() {
    DidSaveReadingStatus(statusCode);
  }), (function() {
    DidFailSaveReadingStatus();
  }));
};

DidSaveReadingStatus = function(data, rawData) {
  $(".button.post").text("发布");
  $(".button.post").attr("disabled", false);
  alert("评论已经发布成功！");
  window.history.back();
};

DidFailSaveReadingStatus = function(data, rawData) {
  alert("服务器过忙，请稍等一会再试");
};

PostMarkAjaxRequest = function(command, type, data, successCallback, failCallback) {
  data.isShareToQQ = false;
  data.isShareToWeibo = false;
  RequestAjax(type, "/book/" + window.bookid + "/" + command, data, DidSaveReadingStatus, DidFailSaveReadingStatus, null);
};

SaveReview = function(statusCode, event) {
  var data, _ref, _ref1, _ref2;
  $(event != null ? event.target : void 0).text("正在发布...");
  $(event != null ? event.target : void 0).attr("disabled", true);
  data = {
    reviewTitle: (_ref = $("input.title").val()) != null ? _ref : "",
    reviewContent: (_ref1 = $("#long textarea").val()) != null ? _ref1 : "",
    bookTitle: window.booktitle,
    score: parseInt((_ref2 = $(".ratingStar").data("score")) != null ? _ref2 : 0),
    markType: statusCode,
    bookImageUrl: window.bookcover,
    bookCategory: window.category,
    bookForMan: window.isforman,
    isShareToQQ: false,
    isShareToWeibo: false
  };
  RequestAjax("POST", "/book/" + window.bookid + "/addreview", data, DidSaveReview, DidFailSaveReview, null);
};

DidSaveReview = function(data, rawData) {
  $(".button.post").text("发布");
  $(".button.post").attr("disabled", false);
  alert("评论已经发布成功！");
  window.history.back();
};

DidFailSaveReview = function(data, rawData) {
  alert("服务器过忙，请稍等一会再试");
};

$(".button.cancel").unbind("click").on("click", function(event) {
  window.history.back(1);
});
