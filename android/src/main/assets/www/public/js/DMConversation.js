// Generated by CoffeeScript 1.7.1
var DidGetNewestMessageData, DidGetPastMessageData, DidPostMessage, FailPostMessage, PostMessage;

$(document).on("deviceready", function() {
  var otherName;
  window.conversations = new Array();
  otherName = getQueryString("other");
  $(".actionbar .page-title").text(unescape(otherName));
  CenterTitle();
  window.conversationId = getQueryString("id");
  RequestAjax("GET", "/mj/people/conversation/" + window.conversationId + "/message/newest", {}, DidGetNewestMessageData, null);
});

DidGetNewestMessageData = function(data, rawData) {
  var messagesHTML;
  if (data.Data.Messages != null) {
    window.conversations = data.Data.Messages;
  }
  if (window.conversations.length > 0) {
    window.oldestId = window.conversations[0].Id;
  }
  window.TotalSum = data.Data.TotalSum;
  messagesHTML = template("DirectMessage/Messages");
  $(".spinner").replaceWith(messagesHTML({
    Messages: window.conversations
  }));
  window.scrollTo(0, document.body.scrollHeight);
  $("#submit").unbind("click").on("click", function(event) {
    var _ref;
    event.preventDefault();
    event.stopPropagation();
    if (((_ref = $(".sendResponseContent").val()) != null ? _ref.length : void 0) <= 0) {
      return alert("请输入回复内容");
    } else {
      $(this).prop("disabled", true);
      window.responseContent = $("#replyInput").val();
      data = {
        id: TimeStamp(),
        content: window.responseContent
      };
      return PostMessage(data);
    }
  });
  $(".loadMore").removeClass("hide").unbind("click").on("click", function(event) {
    RequestAjax("GET", "/mj/people/conversation/" + window.conversationId + "/message/" + window.oldestId + "/before", {}, DidGetPastMessageData, null);
  });
  if ($(".message").length >= window.TotalSum) {
    $(".loadMore").addClass("hide");
  }
};

PostMessage = function(data) {
  var messageHTML, msgData, _ref, _ref1;
  $("#replyInput").val("").blur().focus();
  $("button").prop("disabled", true);
  messageHTML = template("DirectMessage/MineMsg");
  msgData = {
    Id: data.id,
    Poster: {
      Nickname: (_ref = localStorage.SelfNickname) != null ? _ref : "",
      AvatarUrl: (_ref1 = localStorage.SelfAvatarUrl) != null ? _ref1 : "http://shanpowbookcover.qiniudn.com/user-normal.jpg"
    },
    CreationTime: "1秒",
    Content: window.responseContent,
    IsMySelf: true
  };
  $(".messages").append(messageHTML(msgData));
  $("#" + data.id).find(".status").removeClass("hide");
  window.scrollTo(0, document.body.scrollHeight);
  RequestAjax("POST", "/mj/people/conversation/" + window.conversationId + "/message/post", data, DidPostMessage, FailPostMessage, null, null, null, null, false);
};

DidPostMessage = function(data, rawData) {
  $("#" + rawData.Data.id).find(".status").removeClass().addClass("status glyphicons circle_ok");
  $("#" + rawData.Data.id).find(".status").animate({
    opacity: 0
  }, 1000, (function() {
    $(this).css("opacity", 1);
    return $(this).addClass("hide");
  }));
};

FailPostMessage = function(data, rawData) {
  $("#" + rawData.Data.id).find(".status").removeClass().addClass("status glyphicons circle_exclamation_mark");
  $("#" + rawData.Data.id).find(".status").unbind("click").on("click", function(event) {
    $("#" + rawData.Data.id).remove();
    PostMessage(rawData.Data);
  });
};

DidGetPastMessageData = function(data, rawData) {
  var mineMessageHTML, msg, msgToInsert, theirMessageHTML, _i, _len, _ref;
  mineMessageHTML = template("DirectMessage/MineMsg");
  theirMessageHTML = template("DirectMessage/TheirMsg");
  _ref = data.Data.reverse();
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    msg = _ref[_i];
    if (msg.IsMySelf) {
      msgToInsert = mineMessageHTML(msg);
    } else {
      msgToInsert = theirMessageHTML(msg);
    }
    $(".messages").prepend(msgToInsert);
  }
  if ($(".message").length >= window.TotalSum) {
    $(".loadMore").addClass("hide");
  }
  $('html, body').scrollTop($("#" + window.oldestId).offset().top - $(".actionbar").height());
  window.oldestId = $(".message").first().attr("id");
};
