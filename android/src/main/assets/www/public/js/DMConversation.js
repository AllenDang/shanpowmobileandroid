// Generated by CoffeeScript 1.7.1
var DidGetNewestMessageData, DidPostMessage;

$(document).on("deviceready", function() {
  var actionbar, otherName;
  actionbar = template("public/ActionBar");
  $("body").html(actionbar());
  $(".actionbar .channel").addClass("hide");
  $(".actionbar .slide-menu").addClass("hide");
  window.conversations = new Array();
  otherName = getQueryString("other");
  $(".actionbar .page-title").text(unescape(otherName));
  $(".actionbar").children(".center").css("left", ($(window).width() - $(".actionbar .center").children(".page-title").width()) / 2);
  window.conversationId = getQueryString("id");
  RequestAjax("GET", "/mj/people/conversation/" + window.conversationId + "/message/newest", {}, DidGetNewestMessageData, null);
});

DidGetNewestMessageData = function(data, rawData) {
  var messagesHTML;
  if (data.Data != null) {
    window.conversations = data.Data;
  }
  messagesHTML = template("DirectMessage/Messages");
  $(".spinner").replaceWith(messagesHTML({
    Messages: window.conversations
  }));
  window.scrollTo(0, document.body.scrollHeight);
  $("#submit").unbind("click").on("click", function(event) {
    var _ref;
    event.preventDefault();
    event.stopPropagation();
    if (((_ref = $(".sendResponseContent").val()) != null ? _ref.length : void 0) <= 0) {
      return alert("请输入回复内容");
    } else {
      $(this).prop("disabled", true);
      window.responseContent = $("#replyInput").val();
      data = {
        content: window.responseContent
      };
      return RequestAjax("POST", "/mj/people/conversation/" + window.conversationId + "/message/post", data, DidPostMessage, null);
    }
  });
};

DidPostMessage = function(data, rawData) {
  var messageHTML, msgData;
  $("#replyInput").val("").blur().focus();
  $("button").prop("disabled", true);
  messageHTML = template("DirectMessage/MineMsg");
  msgData = {
    Poster: {
      Nickname: "木一",
      AvatarUrl: data.Data.AvatarUrl
    },
    CreationTime: "1秒",
    Content: window.responseContent,
    IsMySelf: true
  };
  $(".messages").append(messageHTML(msgData));
  window.scrollTo(0, document.body.scrollHeight);
};
