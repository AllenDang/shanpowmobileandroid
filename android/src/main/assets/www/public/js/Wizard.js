// Generated by CoffeeScript 1.7.1
var DidGetMarkBookCnt, DidGetRecommendBooks;

$(document).on("deviceready", function() {
  var actionbar;
  actionbar = template("public/ActionBar");
  $(".actions").before(actionbar());
  $(".actionbar .channel").addClass("hide");
  $(".actionbar .slide-menu").addClass("hide");
  $(".spinner").remove();
  $(".actionbar .page-title").text("一键治书荒");
  $(".actionbar").children(".center").css("left", ($(window).width() - $(".actionbar .center").children(".page-title").width()) / 2);
  $(".innerCircle").height($(".innerCircle").width());
  $(".innerCircle").unbind("click").on("click", function(event) {
    var imgUrl;
    if (!$(".info").hasClass("hide")) {
      navigator.notification.alert("提示", "还需要标记更多书籍");
      return;
    }
    imgUrl = $(".circle").attr("src");
    imgUrl.replace("full", "half");
    $(".circle").attr("src", imgUrl);
    $(".tip").text("正在为您努力的搜书...");
    $(".circle").addClass("rotate");
    $("hr").hide();
    $(".info").hide();
    RequestAjax("GET", "/book/recommendations", {}, DidGetRecommendBooks, null, null);
  });
  RequestAjax("GET", "/mj/book/getuserneedmarkbookcnt", {}, DidGetMarkBookCnt, null, null);
});

DidGetMarkBookCnt = function(data, rawData) {
  var count;
  count = parseInt(data.Data.NeedMarkCnt);
  $(".infoText").children("div").children("span").text("" + count);
  if (count > 0) {
    $(".info").removeClass("hide");
    $(".info").prev("hr").removeClass("hide");
  } else {
    $(".info").addClass("hide");
    $(".info").prev("hr").addClass("hide");
  }
};

DidGetRecommendBooks = function(data) {
  var book, bookHTML, htmlToInsert, _i, _len, _ref;
  $(".books").html("");
  htmlToInsert = "";
  if (data.Data != null) {
    _ref = data.Data;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      book = _ref[_i];
      bookHTML = template("public/WizardBook");
      htmlToInsert += bookHTML(book);
    }
  } else {
    htmlToInsert = "<div class='nosimilaruser'>没有找到可以推荐给你的书籍</div>";
  }
  $(".actions").addClass("hide");
  $("body").append("<div class='container'></div>");
  $(".container").append(htmlToInsert);
};
